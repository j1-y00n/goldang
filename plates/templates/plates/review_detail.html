{% extends 'base.html' %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static "plates/detail/detail.css" %}">
<style>
  body {
    background-color: #E9E9E9;
  }
</style>
{% endblock style %}

{% block content %}
<div class="Review__Detail__Container" style="width: 720px;">
  <div class="Review__Detail__Card">
    <div class="Detail__Review__Detail" style="padding: 0;">
      <div class="Detail__Review__Detail__User">
        <a href="{% url 'accounts:profile' review.user %}">
          <div class="d-flex flex-row">
            {% if review.user.picture %}
            <div ><img class="Detail__Review__Detail__UserImg" src="{{ review.user.picture.url }}" alt="프로필이미지"></div>
            {% else %}
            <div><img class="Detail__Review__Detail__UserImg" src="{% static 'plates/no_image.png' %}" alt="대체이미지"></div>
            {% endif %}
            <div class="Detail__Review__Detail__UserInfo">
              <span class="Detail__Review__Detail__UserName">{{ review.user }}</span>
              <ul class="Detail__Review__Detail__Count">
                <span class="Detail__Review__User__StatItem--Review" style="margin-right: 5px;"></span><li class="" style="margin-right: 5px;">{{ review.user.review_set.all|length }}</li>
                <span class="Detail__Review__User__StatItem--Follower" style="margin-right: 5px;"></span><li class="" style="margin-right: 5px;">{{ person.followers.all|length }}</li>
              </ul>
            </div>
          </div>
        </a>
        <div class="Detail__Review__Detail__TastEvaluation">
          {% if review.taste_evaluation == 5 %}
            <i class="Detail__Review__TasteEvaluation--Delicious"></i>
            <span class="Detail__Review__TasteEvaluationText">맛있다</span>
          {% elif review.taste_evaluation == 3 %}
            <i class="Detail__Review__TasteEvaluation--Smile"></i>
            <span class="Detail__Review__TasteEvaluationText">괜찮다</span>
          {% elif review.taste_evaluation == 1 %}
            <i class="Detail__Review__TasteEvaluation--Sad"></i>
            <span class="Detail__Review__TasteEvaluationText">별로</span>
          {% endif %}                  
        </div>
      </div>
      <div>  
        <p class="Detail__Review__Text">{{ review.content }}</p>
      </div>
      <div class="Detail__Review__Detail__ImgContainer">  
        {% if review_images %}
        {% for image in review_images %}
          <button type="button" class="Detail__Review__Detail__ImgBox" data-bs-toggle="modal" data-bs-target="#ReviewDetailImg">
            <img class="Detail__Review__Detail__Img" src="{{ image.image.url }}" alt="리뷰이미지">            
          </button>
          {% endfor %}
        {% else %}
          <img class="Detail__Review__Detail__Img" src="{% static 'plates/no_image.png' %}" alt="대체이미지">
        {% endif %}
      </div>
      <span class="Detail__Review__Date">{{ review.created_at|date:"Y-m-d" }}</span>
    </div>
  </div>
</div>

{% comment %} Modal {% endcomment %}
<div class="modal fade" id="ReviewDetailImg" tabindex="-1" aria-labelledby="ReviewDetailImgLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="position: static; margin-left: 23%; margin-right: 25%;">
    <div class="modal-content text-end" style="background-color: #000000; width: 1000px;">
      <div class="modal-body" style="width: 1000px;">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        {% comment %} carousel {% endcomment %}
        <div id="ReviewDetailImgIndicators" class="carousel slide" data-bs-interval="100">
          <div class="carousel-inner">
            {% for image in review_images %}
              {% if forloop.first %}
              <div class="carousel-item text-center active " data-bs-slide-to="{{ forloop.counter0 }}">
                <img class="Review__Detail__CarouselImg" src="{{ image.image.url }}" alt="리뷰이미지">  
              </div>
              {% else %}
              <div class="carousel-item text-center" data-bs-slide-to="{{ forloop.counter0 }}">
                <img class="Review__Detail__CarouselImg" src="{{ image.image.url }}" alt="리뷰이미지">  
              </div>
              {% endif %}
            {% endfor %}
          </div>
          <div class="Carousel__Indicators">
            {% for image in review_images %}
              {% if forloop.first %}
              <div class="Review__Detail__FooterImgbox">
                <button type="button" data-bs-target="#ReviewDetailImgIndicators" data-bs-slide-to="{{ forloop.counter0 }}" class="active" aria-current="true" aria-label="Slide {{ forloop.counter}}">
                  <img class="Review__Detail__FooterImg" src="{{ image.image.url }}" alt="리뷰이미지">
                </button>
              </div>
              {% else %}
              <div class="Review__Detail__FooterImgbox">
                <button type="button" data-bs-target="#ReviewDetailImgIndicators" data-bs-slide-to="{{ forloop.counter0 }}" class="active-none" aria-label="Slide {{ forloop.counter}}">
                  <img class="Review__Detail__FooterImg" src="{{ image.image.url }}" alt="리뷰이미지">
                </button>
              </div>
              {% endif %}
            {% endfor %}
          </div>
          <div>
            <button class="carousel-control-prev" type="button" data-bs-target="#ReviewDetailImgIndicators" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#ReviewDetailImgIndicators" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>           
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script>
  var imgBoxes = document.querySelectorAll('.Detail__Review__Detail__ImgBox');
  var modalImage = document.querySelector('#ReviewDetailImg .Review__Detail__CarouselImg');
  var prevButton = document.querySelector('.carousel-control-prev');
  var nextButton = document.querySelector('.carousel-control-next');
  var indicators = document.querySelectorAll('.Carousel__Indicators button');

  // 이미지 박스 클릭 시 해당 이미지를 모달에 출력
  imgBoxes.forEach(function(imgBox) {
    imgBox.addEventListener('click', function() {
      var modalCarousel = document.querySelector('#ReviewDetailImgIndicators');
      var modalImages = modalCarousel.querySelectorAll('.Review__Detail__CarouselImg');
      var selectedImageUrl = this.querySelector('.Detail__Review__Detail__Img').src;
      

      // 선택한 이미지의 인덱스를 찾기 위해 Array.from을 사용하여 modalImages를 배열로 변환
      var activeIndex = Array.from(modalImages).findIndex(function(image) {
        return image.src === selectedImageUrl;
      });
      console.log(activeIndex)

      // Bootstrap 모달 이미지를 업데이트하기 위해 active 클래스 설정
      modalImages.forEach(function(image) {
        image.parentNode.classList.remove('active');
      });
      
      console.log(modalImages[activeIndex].parentNode)
      // 선택한 이미지의 부모 클래스에 active 추가
      modalImages[activeIndex].parentNode.classList.add('active');
      

      // Bootstrap 모달 열기
      $('#ReviewDetailImg').modal('show');

      // Review__Detail__FooterImgbox의 자식 button에서 active 클래스 제거 및 active-none 클래스 추가
      var footerImgBoxes = document.querySelectorAll('.Review__Detail__FooterImgbox');
      footerImgBoxes.forEach(function(box) {
        var button = box.querySelector('button');
        if (button.classList.contains('active')) {
          button.classList.remove('active');
          button.classList.add('active-none');
          button.setAttribute('aria-current', 'false');
        }
      });

      // 선택한 이미지와 일치하는 Review__Detail__FooterImg의 부모 버튼에 active 클래스 및 aria-current 추가
      var matchingButton = document.querySelector('.Review__Detail__FooterImgbox button[data-bs-slide-to="' + activeIndex + '"]');
      console.log(matchingButton)
      if (matchingButton) {
        matchingButton.classList.add('active');
        matchingButton.classList.remove('active-none');
        matchingButton.setAttribute('aria-current', 'true');
      }

      // 그 외의 Review__Detail__FooterImg의 부모 버튼에 active-none 클래스 추가 및 aria-current 제거
      var nonMatchingButtons = document.querySelectorAll('.Review__Detail__FooterImgbox button:not([data-bs-slide-to="' + activeIndex + '"])');
      console.log(nonMatchingButtons)
      nonMatchingButtons.forEach(function(button) {
        button.classList.add('active-none');
        button.setAttribute('aria-current', 'false');
      });

      // 페이지 로드 시 초기 설정
      var activeSlide = prevcarousel.querySelector('.carousel-item.active');
      var isFirstSlide = activeSlide && activeSlide.dataset.bsSlideTo === '0';
      
      if (isFirstSlide) {
      prevButton2.style.display = 'none'; // 이전(prev) 버튼 숨기기
      } else {
      prevButton2.style.display = 'block'; // 이전(prev) 버튼 보이기
      }
      
      var lastIndex = prevcarousel.querySelectorAll('.carousel-item').length - 1;
      var isLastSlide = activeSlide && activeSlide.dataset.bsSlideTo === lastIndex.toString();
      
      if (isLastSlide) {
      nextButton2.style.display = 'none'; // 다음(next) 버튼 숨기기
      } else {
      nextButton2.style.display = 'block'; // 다음(next) 버튼 보이기
      }
    });
  });

  // 이전 버튼 클릭 시 다음 버튼 활성화 처리
  prevButton.addEventListener('click', function() {
    var footerImgBoxes = document.querySelectorAll('.Review__Detail__FooterImgbox');
    var activeButton = null;

    footerImgBoxes.forEach(function(box) {
      var button = box.querySelector('button');
      if (button.classList.contains('active')) {
        activeButton = button;
      }
      button.classList.remove('active');
      button.classList.add('active-none');
      button.setAttribute('aria-current', 'false');
    });

    if (activeButton !== null) {
      var prevIndex = parseInt(activeButton.getAttribute('data-bs-slide-to')) - 1;
      var prevButton = document.querySelector('.Review__Detail__FooterImgbox button[data-bs-slide-to="' + prevIndex + '"]');
      prevButton.classList.remove('active-none');
      prevButton.classList.add('active');
      prevButton.setAttribute('aria-current', 'true');
    }
  });

  // 다음 버튼 클릭 시 다음 버튼 활성화 처리
  nextButton.addEventListener('click', function() {
    var footerImgBoxes = document.querySelectorAll('.Review__Detail__FooterImgbox');
    var activeButton = null;

    footerImgBoxes.forEach(function(box) {
      var button = box.querySelector('button');
      if (button.classList.contains('active')) {
        activeButton = button;
      }
      button.classList.remove('active');
      button.classList.add('active-none');
      button.setAttribute('aria-current', 'false');
    });

    if (activeButton !== null) {
      var nextIndex = parseInt(activeButton.getAttribute('data-bs-slide-to')) + 1;
      var nextButton = document.querySelector('.Review__Detail__FooterImgbox button[data-bs-slide-to="' + nextIndex + '"]');
      nextButton.classList.remove('active-none');
      nextButton.classList.add('active');
      nextButton.setAttribute('aria-current', 'true');
    }
  });

  // 이미지 버튼 클릭 시 해당 버튼 활성화 처리
  indicators.forEach(function(button) {
    button.addEventListener('click', function() {
      indicators.forEach(function(btn) {
        btn.classList.remove('active');
        btn.classList.add('active-none');
        btn.setAttribute('aria-current', 'false');
      });

      button.classList.remove('active-none');
      button.classList.add('active');
      button.setAttribute('aria-current', 'true');
    });
  });

  // 슬라이드 이동 시 이전/다음 버튼 숨기기/보이기 처리
  var prevcarousel = document.querySelector('#ReviewDetailImgIndicators');
  var prevButton2 = prevcarousel.querySelector('.carousel-control-prev');
  var nextcarousel = document.querySelector('#ReviewDetailImgIndicators');
  var nextButton2 = nextcarousel.querySelector('.carousel-control-next');

  prevcarousel.addEventListener('slide.bs.carousel', function(event) {
    var isFirstSlide = event.to === 0;
    if (isFirstSlide) {
      prevButton2.style.display = 'none'; // 이전(prev) 버튼 숨기기
      } else {
      prevButton2.style.display = 'block'; // 이전(prev) 버튼 보이기
      }
  });
      
  nextcarousel.addEventListener('slide.bs.carousel', function(event) {
    var totalSlides = event.relatedTarget.parentElement.children.length;
    var isLastSlide = event.to === totalSlides - 1;
    
    if (isLastSlide) {
    nextButton2.style.display = 'none'; // 다음(next) 버튼 숨기기
    } else {
    nextButton2.style.display = 'block'; // 다음(next) 버튼 보이기
    }
  });
      
  

</script>
{% endblock content %}